{% extends 'base.html' %}
{% load static %}

{% block title %}Financial Analysis - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: all 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .chart-container {
        position: relative;
        height: 320px;
    }
    .stat-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Financial Analysis Dashboard</h1>
                    <p class="mt-2 text-sm text-gray-600">
                        <i class="fas fa-mobile-alt text-green-600"></i>
                        M-Pesa Payment Analytics & Revenue Tracking
                    </p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-3">
                    <a href="{% url 'admin_panel:payment_management' %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                        <i class="fas fa-list mr-2"></i>
                        All Payments
                    </a>
                    <button onclick="window.print()"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition">
                        <i class="fas fa-print mr-2"></i>
                        Export Report
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Metrics Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Total Revenue Card -->
            <div class="metric-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-30 rounded-lg p-3">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                    <span class="stat-badge bg-white bg-opacity-30">
                        <i class="fas fa-arrow-up mr-1"></i>
                        {{ completed_count }}
                    </span>
                </div>
                <p class="text-sm font-medium text-green-100 uppercase tracking-wide">Total Revenue</p>
                <p class="text-3xl font-bold mt-2">KES {{ total_revenue|floatformat:2|default:"0.00" }}</p>
                <p class="text-sm text-green-100 mt-2">From completed transactions</p>
            </div>

            <!-- Pending Revenue Card -->
            <div class="metric-card bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-30 rounded-lg p-3">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <span class="stat-badge bg-white bg-opacity-30">
                        <i class="fas fa-hourglass-half mr-1"></i>
                        {{ pending_count }}
                    </span>
                </div>
                <p class="text-sm font-medium text-yellow-100 uppercase tracking-wide">Pending Revenue</p>
                <p class="text-3xl font-bold mt-2">KES {{ pending_revenue|floatformat:2|default:"0.00" }}</p>
                <p class="text-sm text-yellow-100 mt-2">Awaiting confirmation</p>
            </div>

            <!-- Failed Revenue Card -->
            <div class="metric-card bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-30 rounded-lg p-3">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <span class="stat-badge bg-white bg-opacity-30">
                        <i class="fas fa-times mr-1"></i>
                        {{ failed_count }}
                    </span>
                </div>
                <p class="text-sm font-medium text-red-100 uppercase tracking-wide">Failed Revenue</p>
                <p class="text-3xl font-bold mt-2">KES {{ failed_revenue|floatformat:2|default:"0.00" }}</p>
                <p class="text-sm text-red-100 mt-2">Lost opportunities</p>
            </div>

            <!-- Success Rate Card -->
            <div class="metric-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-30 rounded-lg p-3">
                        <i class="fas fa-percentage text-2xl"></i>
                    </div>
                    <span class="stat-badge bg-white bg-opacity-30">
                        <i class="fas fa-chart-line mr-1"></i>
                        Rate
                    </span>
                </div>
                <p class="text-sm font-medium text-blue-100 uppercase tracking-wide">Success Rate</p>
                <p class="text-3xl font-bold mt-2">{{ success_rate|default:"0" }}%</p>
                <p class="text-sm text-blue-100 mt-2">Avg: KES {{ avg_transaction|floatformat:2|default:"0.00" }}</p>
            </div>
        </div>

        <!-- Transaction Type Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-pie text-indigo-600 mr-2"></i>
                    Transaction Breakdown
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-700">Registration Fees</p>
                                <p class="text-xs text-gray-500">{{ registration_count }} transactions</p>
                            </div>
                        </div>
                        <p class="text-lg font-bold text-blue-600">KES {{ registration_revenue|floatformat:2|default:"0.00" }}</p>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-100">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-purple-500 rounded-full mr-3"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-700">Subscription Fees</p>
                                <p class="text-xs text-gray-500">{{ subscription_count }} transactions</p>
                            </div>
                        </div>
                        <p class="text-lg font-bold text-purple-600">KES {{ subscription_revenue|floatformat:2|default:"0.00" }}</p>
                    </div>

                    <div class="pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">Total Transactions</span>
                            <span class="text-xl font-bold text-gray-900">{{ total_transactions }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>
                    Revenue Distribution
                </h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Status Distribution Chart -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                Payment Status Overview
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="flex items-center">
                    <div class="w-full space-y-4">
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                    {{ completed_count }}
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-700">Completed Payments</p>
                                    <p class="text-xs text-gray-500">Successfully processed</p>
                                </div>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-500"></i>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                    {{ pending_count }}
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-700">Pending Payments</p>
                                    <p class="text-xs text-gray-500">Awaiting confirmation</p>
                                </div>
                            </div>
                            <i class="fas fa-hourglass-half text-3xl text-yellow-500"></i>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                    {{ failed_count }}
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-700">Failed Payments</p>
                                    <p class="text-xs text-gray-500">Requires attention</p>
                                </div>
                            </div>
                            <i class="fas fa-times-circle text-3xl text-red-500"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights & Recommendations -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                Key Insights & Recommendations
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-600 text-xl mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-green-900 mb-1">Revenue Secured</h4>
                            <p class="text-sm text-green-800">Successfully collected <strong>KES {{ total_revenue|floatformat:2|default:"0.00" }}</strong> from {{ completed_count }} completed M-Pesa transactions. Payment system is functioning well.</p>
                        </div>
                    </div>
                </div>

                <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-yellow-900 mb-1">Action Required</h4>
                            <p class="text-sm text-yellow-800"><strong>KES {{ pending_revenue|floatformat:2|default:"0.00" }}</strong> in pending payments. Monitor these transactions and consider automated follow-up for failed STK pushes.</p>
                        </div>
                    </div>
                </div>

                <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-times-circle text-red-600 text-xl mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-red-900 mb-1">Investigate Failures</h4>
                            <p class="text-sm text-red-800">{{ failed_count }} failed transactions totaling <strong>KES {{ failed_revenue|floatformat:2|default:"0.00" }}</strong>. Review M-Pesa error codes and improve user payment guidance.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-receipt text-indigo-600 mr-2"></i>
                    Recent Transactions
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-phone mr-1"></i> Phone
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-money-bill mr-1"></i> Amount
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-tag mr-1"></i> Type
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-info-circle mr-1"></i> Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-receipt mr-1"></i> Receipt
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-calendar mr-1"></i> Date
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for payment in recent_transactions %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ payment.phone_number }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                                KES {{ payment.amount|floatformat:2 }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full {% if payment.transaction_type == 'REGISTRATION' %}bg-blue-100 text-blue-800{% else %}bg-purple-100 text-purple-800{% endif %}">
                                    {{ payment.transaction_type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full {% if payment.status == 'completed' %}bg-green-100 text-green-800{% elif payment.status == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    <i class="fas {% if payment.status == 'completed' %}fa-check{% elif payment.status == 'pending' %}fa-clock{% else %}fa-times{% endif %} mr-1"></i>
                                    {{ payment.status|upper }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">
                                {{ payment.mpesa_receipt_number|default:"-" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ payment.payment_date|date:"M d, Y h:i A" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                                <p>No transactions found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if recent_transactions %}
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 text-center">
                <a href="{% url 'admin_panel:payment_management' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">
                    View all {{ total_transactions }} transactions <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Parse data from Django
    const statusData = {{ status_chart_data|safe }};
    const typeData = {{ type_chart_data|safe }};

    // Configure Chart.js defaults to disable animations
    Chart.defaults.animation = false;
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    // Status Chart (Doughnut)
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusData.labels,
                datasets: [{
                    data: statusData.data,
                    backgroundColor: statusData.colors,
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                animation: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + ' transactions';
                            }
                        }
                    }
                }
            }
        });
    }

    // Revenue Chart (Bar)
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: typeData.labels,
                datasets: [{
                    label: 'Revenue (KES)',
                    data: typeData.data,
                    backgroundColor: typeData.colors,
                    borderRadius: 8,
                    borderWidth: 0
                }]
            },
            options: {
                animation: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: KES ' + context.parsed.y.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString('en-KE');
                            }
                        },
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}