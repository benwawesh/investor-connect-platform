{% extends 'base.html' %}

{% block title %}{{ user.username }} - User Details{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center">
        <a href="{% url 'admin_panel:user_management' %}" class="text-blue-600 hover:text-blue-800 mr-4">
            <i class="fas fa-arrow-left mr-2"></i>Back to User Management
        </a>
        <h1 class="text-3xl font-bold text-gray-900">User Details</h1>
    </div>
</div>

<!-- User Overview -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-6">
        <div class="flex items-center space-x-6">
            <!-- Profile Picture -->
            <div class="flex-shrink-0">
                {% if profile_extension.profile_picture %}
                <img class="h-20 w-20 rounded-full object-cover" src="{{ profile_extension.profile_picture.url }}" alt="{{ user.username }}">
                {% else %}
                <div class="h-20 w-20 rounded-full bg-gray-300 flex items-center justify-center">
                    <i class="fas fa-user text-gray-600 text-2xl"></i>
                </div>
                {% endif %}
            </div>
            
            <!-- User Info -->
            <div class="flex-1">
                <div class="flex items-center space-x-4 mb-2">
                    <h2 class="text-2xl font-bold text-gray-900">{{ user.username }}</h2>
                    
                    <!-- User Type Badge -->
                    {% if user.user_type == 'investor' %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-coins mr-1"></i>Investor
                    </span>
                    {% elif user.user_type == 'job_seeker' %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                        <i class="fas fa-user-tie mr-1"></i>Job Seeker
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        <i class="fas fa-rocket mr-1"></i>Regular User
                    </span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                    <div><strong>Email:</strong> {{ user.email }}</div>
                    <div><strong>Phone:</strong> {{ user.phone_number|default:"Not provided" }}</div>
                    <div><strong>Joined:</strong> {{ user.created_at|date:"F d, Y" }}</div>
                    <div><strong>Last Updated:</strong> {{ user.updated_at|date:"F d, Y" }}</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="flex flex-col space-y-2">
                {% if not user.is_verified %}
                <button onclick="verifyUser({{ user.id }})" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-check mr-2"></i>Verify User
                </button>
                {% endif %}
                
                {% if user.account_status != 'suspended' and not user.is_staff %}
                <button onclick="suspendUser({{ user.id }})" 
                        class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                    <i class="fas fa-pause mr-2"></i>Suspend
                </button>
                {% elif user.account_status == 'suspended' %}
                <button onclick="unsuspendUser({{ user.id }})" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-play mr-2"></i>Unsuspend
                </button>
                {% endif %}
                
                {% if not user.is_staff %}
                <button onclick="deleteUser({{ user.id }}, '{{ user.username }}')" 
                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <!-- Verification Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                {% if user.is_verified %}
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                {% else %}
                <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600"></i>
                </div>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-500">Verification</p>
                <p class="text-lg font-semibold text-gray-900">
                    {% if user.is_verified %}Verified{% else %}Pending{% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Account Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                {% if user.account_status == 'active' %}
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-check text-green-600"></i>
                </div>
                {% elif user.account_status == 'suspended' %}
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-ban text-red-600"></i>
                </div>
                {% else %}
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-times-circle text-gray-600"></i>
                </div>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-500">Account Status</p>
                <p class="text-lg font-semibold text-gray-900 capitalize">{{ user.get_account_status_display }}</p>
            </div>
        </div>
    </div>
    
    <!-- Payment Status -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                {% if user.user_type == 'investor' or user.user_type == 'job_seeker' %}
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-minus text-gray-600"></i>
                </div>
                {% elif user.subscription_paid %}
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-green-600"></i>
                </div>
                {% else %}
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-times text-red-600"></i>
                </div>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-500">Payment</p>
                <p class="text-lg font-semibold text-gray-900">
                    {% if user.user_type == 'investor' or user.user_type == 'job_seeker' %}
                    N/A
                    {% elif user.subscription_paid %}
                    Paid
                    {% else %}
                    Unpaid
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Platform Access -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                {% if user.can_access_platform %}
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-unlock text-green-600"></i>
                </div>
                {% else %}
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-lock text-red-600"></i>
                </div>
                {% endif %}
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-500">Platform Access</p>
                <p class="text-lg font-semibold text-gray-900">
                    {% if user.can_access_platform %}Granted{% else %}Blocked{% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Suspension Info (if suspended) -->
{% if user.account_status == 'suspended' and suspension_info.is_suspended %}
<div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
    <div class="flex items-center mb-4">
        <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
        <h3 class="text-lg font-semibold text-red-900">Account Suspended</h3>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div>
            <strong class="text-red-900">Until:</strong>
            <p class="text-red-700">{{ user.suspended_until|date:"F d, Y H:i" }}</p>
        </div>
        <div>
            <strong class="text-red-900">Days Remaining:</strong>
            <p class="text-red-700">{{ suspension_info.days_remaining|default:"Indefinite" }}</p>
        </div>
        <div>
            <strong class="text-red-900">Reason:</strong>
            <p class="text-red-700">{{ user.suspension_reason|default:"No reason provided" }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Tabs -->
<div class="bg-white rounded-lg shadow">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex">
            <button onclick="showTab('profile')" id="profile-tab" 
                    class="tab-button py-4 px-6 border-b-2 border-blue-500 text-blue-600 font-medium">
                Profile Information
            </button>
            <button onclick="showTab('activity')" id="activity-tab" 
                    class="tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                Activity & Stats
            </button>
            <button onclick="showTab('payments')" id="payments-tab" 
                    class="tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                Payment History
            </button>
        </nav>
    </div>
    
    <!-- Profile Tab -->
    <div id="profile-content" class="tab-content p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Profile Information</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Basic Information -->
            <div>
                <h4 class="font-medium text-gray-900 mb-3">Basic Information</h4>
                <div class="space-y-3 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Full Name:</span>
                        <span class="text-gray-600 ml-2">
                            {% if profile_extension %}
                                {{ profile_extension.get_full_name }}
                            {% else %}
                                Not provided
                            {% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Location:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.location|default:"Not provided" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Company:</span>
                        <span class="text-gray-600 ml-2">{{ user.company_name|default:"Not provided" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Job Title:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.job_title|default:"Not provided" }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Professional Information -->
            <div>
                <h4 class="font-medium text-gray-900 mb-3">Professional Details</h4>
                <div class="space-y-3 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Industry:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.get_industry_display|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Experience Level:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.get_experience_level_display|default:"Not specified" }}</span>
                    </div>
                    {% if user.user_type == 'investor' %}
                    <div>
                        <span class="font-medium text-gray-700">Investment Range:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.get_investment_range_display|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Investment Focus:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.get_investment_focus_display|default:"Not specified" }}</span>
                    </div>
                    {% elif user.user_type == 'regular' %}
                    <div>
                        <span class="font-medium text-gray-700">Business Stage:</span>
                        <span class="text-gray-600 ml-2">{{ profile_extension.get_business_stage_display|default:"Not specified" }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Funding Goal:</span>
                        <span class="text-gray-600 ml-2">${{ profile_extension.funding_goal|default:"Not specified" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Description -->
        {% if user.profile_description %}
        <div class="mt-6">
            <h4 class="font-medium text-gray-900 mb-3">Description</h4>
            <p class="text-gray-600 text-sm leading-relaxed">{{ user.profile_description }}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Activity Tab -->
    <div id="activity-content" class="tab-content p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Activity & Statistics</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-gray-900">0</div>
                <div class="text-sm text-gray-600">Messages Sent</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-gray-900">0</div>
                <div class="text-sm text-gray-600">Pitches Submitted</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-2xl font-bold text-gray-900">0</div>
                <div class="text-sm text-gray-600">Job Applications</div>
            </div>
        </div>
        
        <div class="mt-6">
            <p class="text-gray-600 text-sm">Activity tracking coming soon...</p>
        </div>
    </div>
    
    <!-- Payments Tab -->
    <div id="payments-content" class="tab-content p-6 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment History</h3>
        
        {% if payments %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for payment in payments %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ payment.payment_date|date:"M d, Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ payment.currency }} {{ payment.amount }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                {% if payment.status == 'completed' %}bg-green-100 text-green-800
                                {% elif payment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ payment.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            M-Pesa
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-600 text-sm">No payment history available.</p>
        {% endif %}
    </div>
</div>

<script>
// Tab functionality
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-content').classList.remove('hidden');
    
    // Activate selected tab
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-blue-500', 'text-blue-600');
}

// User management functions
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                  document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

function verifyUser(userId) {
    if (confirm('Are you sure you want to verify this user?')) {
        fetch(`/admin-panel/users/${userId}/verify/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error verifying user');
            }
        });
    }
}

function suspendUser(userId) {
    const duration = prompt('Suspension duration in days:', '7');
    const reason = prompt('Suspension reason:', 'Administrative action');
    
    if (duration && reason) {
        fetch(`/admin-panel/users/${userId}/suspend/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `duration=${duration}&reason=${encodeURIComponent(reason)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error suspending user');
            }
        });
    }
}

function unsuspendUser(userId) {
    if (confirm('Are you sure you want to unsuspend this user?')) {
        fetch(`/admin-panel/users/${userId}/unsuspend/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error unsuspending user');
            }
        });
    }
}

function deleteUser(userId, username) {
    if (confirm(`Are you sure you want to permanently delete user "${username}"? This action cannot be undone.`)) {
        fetch(`/admin-panel/users/${userId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/admin-panel/users/';
            } else {
                alert(data.message || 'Error deleting user');
            }
        });
    }
}
</script>
{% endblock %}