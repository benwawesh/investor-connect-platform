{% extends 'base.html' %}

{% block title %}Enhanced Chat - InvestorConnect{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Chat Header with Online Status and Profile Links -->
    <div class="bg-white rounded-t-lg shadow p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{% url 'chat:chat_list' %}" class="text-blue-600 hover:text-blue-800">
                    ‚Üê Back to Messages
                </a>
                <div class="flex items-center space-x-3">
                    <!-- Profile Picture -->
                    {% if other_user and other_user.username %}
                        <a href="{% url 'accounts:profile_detail' username=other_user.username %}" class="flex-shrink-0">
                            {% if other_user.userprofileextension.profile_picture %}
                                <img src="{{ other_user.userprofileextension.profile_picture.url }}"
                                     alt="{{ other_user.username }}"
                                     class="w-10 h-10 rounded-full object-cover border-2 border-gray-200 hover:border-blue-400 transition-colors">
                            {% else %}
                                <div class="w-10 h-10 rounded-full
                                    {% if other_user.is_staff %}bg-red-500
                                    {% elif other_user.is_investor %}bg-green-500
                                    {% else %}bg-blue-500{% endif %}
                                    flex items-center justify-center border-2 border-gray-200 hover:border-blue-400 transition-colors">
                                    <span class="text-white font-medium">{{ other_user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                        </a>
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center border-2 border-gray-200">
                            <span class="text-white font-medium">?</span>
                        </div>
                    {% endif %}

                    <!-- Name and Status -->
                    <div>
                        <h2 class="text-xl font-semibold">
                            {% if other_user and other_user.username %}
                                <a href="{% url 'accounts:profile_detail' username=other_user.username %}"
                                   class="hover:text-blue-600 transition-colors flex items-center">
                                    {% if other_user.userprofileextension.get_full_name %}
                                        {{ other_user.userprofileextension.get_full_name }}
                                    {% else %}
                                        {{ other_user.username }}
                                    {% endif %}
                                    {% if other_user.is_staff %}
                                        <i class="fas fa-shield-alt text-red-600 ml-2 text-sm" title="Administrator"></i>
                                    {% elif other_user.is_investor %}
                                        <i class="fas fa-coins text-green-600 ml-2 text-sm" title="Investor"></i>
                                    {% else %}
                                        <i class="fas fa-lightbulb text-blue-600 ml-2 text-sm" title="Entrepreneur"></i>
                                    {% endif %}
                                </a>
                            {% else %}
                                <span class="text-gray-500">Unknown User</span>
                            {% endif %}
                        </h2>
                        <div id="otherUserStatus" class="text-sm text-gray-500">
                            Checking status...
                        </div>
                    </div>
                </div>
            </div>
            <div id="connectionStatus" class="text-sm px-3 py-1 rounded-full bg-yellow-200 text-yellow-800">
                Connecting...
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="bg-gray-50 border h-96 overflow-y-auto p-4" id="messagesContainer">
        <div id="messagesList">
            <div class="text-center py-8 text-gray-500" id="loadingText">
                Loading chat history...
            </div>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div class="bg-gray-100 px-4 py-2 border-b" id="typingContainer" style="display: none;">
        <div id="typingIndicator" class="text-sm text-blue-600 italic">
            <!-- Typing indicator will appear here -->
        </div>
    </div>

    <!-- Message Input -->
    <div class="bg-white rounded-b-lg shadow p-4">
        <form id="messageForm" class="flex space-x-2">
            <input type="text" id="messageInput" placeholder="Type your message..."
                   class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   disabled autocomplete="off">
            <button type="submit" id="sendButton"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    disabled>
                Send
            </button>
        </form>
        <div class="mt-2 flex justify-between items-center">
            <span id="messageCount" class="text-xs text-gray-500">Loading...</span>
            <span id="connectionInfo" class="text-xs text-gray-500">Connecting...</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messagesList = document.getElementById('messagesList');
    const messagesContainer = document.getElementById('messagesContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const otherUserStatus = document.getElementById('otherUserStatus');
    const sendButton = document.getElementById('sendButton');
    const messageCount = document.getElementById('messageCount');
    const loadingText = document.getElementById('loadingText');
    const typingContainer = document.getElementById('typingContainer');
    const typingIndicator = document.getElementById('typingIndicator');
    const connectionInfo = document.getElementById('connectionInfo');

    // State variables
    let totalMessages = 0;
    let isConnected = false;
    let hasLoadedHistory = false;
    let isTyping = false;
    let typingTimer = null;
    let otherUserIsOnline = false;
    let otherUserName = '';

    // Get other user's username for profile links - safe fallback
    const otherUsername = '{{ other_user.username|default:"" }}';

    // WebSocket setup
    const roomId = '{{ chat_room.id }}';
    const currentUserId = {{ user.id }};
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsPath = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;

    console.log('üîå Connecting to enhanced WebSocket:', wsPath);
    let chatSocket = new WebSocket(wsPath);

    // Utility functions
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function formatLastSeen(isoString) {
        if (!isoString) return 'Unknown';

        const date = new Date(isoString);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));

        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;

        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ago`;

        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
    }

    function updateConnectionStatus(text, bgColor, textColor) {
        connectionStatus.textContent = text;
        connectionStatus.className = `text-sm px-3 py-1 rounded-full ${bgColor} ${textColor}`;
    }

    function updateOtherUserStatus(username, isOnline, lastSeen) {
        otherUserName = username;
        otherUserIsOnline = isOnline;

        if (isOnline) {
            otherUserStatus.innerHTML = `<span class="text-green-600">‚óè Online</span>`;
        } else {
            otherUserStatus.innerHTML = `<span class="text-gray-500">‚óã Last seen ${formatLastSeen(lastSeen)}</span>`;
        }
    }

    function updateMessageCount() {
        messageCount.textContent = `${totalMessages} message${totalMessages !== 1 ? 's' : ''}`;
    }

    function hideLoadingText() {
        if (loadingText && !hasLoadedHistory) {
            loadingText.style.display = 'none';
            hasLoadedHistory = true;
        }
    }

    function showTypingIndicator(username) {
        typingIndicator.textContent = `${username} is typing...`;
        typingContainer.style.display = 'block';
        scrollToBottom();
    }

    function hideTypingIndicator() {
        typingContainer.style.display = 'none';
    }

    function sendTypingStatus(typing) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': typing ? 'typing_start' : 'typing_stop'
            }));
        }
    }

    function markMessageAsRead(messageId) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'message_read',
                'message_id': messageId
            }));
        }
    }

    // Function to make message usernames clickable
    function makeMessageUserNameClickable(messageElement, username) {
        const userNameSpan = messageElement.querySelector('.message-username');
        if (userNameSpan && username !== '{{ user.username }}' && username) {
            userNameSpan.style.cursor = 'pointer';
            userNameSpan.style.color = '#2563eb';
            userNameSpan.addEventListener('click', function() {
                window.location.href = `{% url 'accounts:profile_detail' username='PLACEHOLDER' %}`.replace('PLACEHOLDER', username);
            });
            userNameSpan.addEventListener('mouseenter', function() {
                this.style.textDecoration = 'underline';
            });
            userNameSpan.addEventListener('mouseleave', function() {
                this.style.textDecoration = 'none';
            });
        }
    }

    // Add message with enhanced features and clickable usernames
    function addMessage(data, isNewMessage = false) {
        hideLoadingText();

        const isOwnMessage = data.is_own_message || (data.sender_id === currentUserId);

        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${isOwnMessage ? 'text-right' : 'text-left'}`;
        messageDiv.setAttribute('data-message-id', data.message_id || 'temp');

        const bubbleClass = isOwnMessage ?
            'bg-blue-600 text-white' :
            'bg-white border border-gray-200 text-gray-900';

        const timeClass = isOwnMessage ? 'text-blue-100' : 'text-gray-500';

        // Message status indicators
        let statusIcon = '';
        if (isOwnMessage) {
            if (data.read) {
                statusIcon = '<span class="text-xs ml-1" title="Read">‚úì‚úì</span>';
            } else if (data.delivered) {
                statusIcon = '<span class="text-xs ml-1" title="Delivered">‚úì</span>';
            } else {
                statusIcon = '<span class="text-xs ml-1" title="Sending">‚óã</span>';
            }
        }

        // New message indicator
        const newIndicator = isNewMessage ?
            '<span class="text-xs opacity-75 animate-pulse mr-1">‚óè</span>' : '';

        // Make username clickable for other users
        const usernameClass = !isOwnMessage ? 'message-username' : '';

        messageDiv.innerHTML = `
            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                <div class="text-xs mb-1 opacity-75 ${usernameClass}">
                    ${newIndicator}${isOwnMessage ? 'You' : data.sender_name}
                </div>
                <p class="text-sm break-words">${data.message}</p>
                <div class="flex justify-between items-center mt-1">
                    <span class="text-xs ${timeClass}">
                        ${formatTime(data.timestamp)}
                    </span>
                    ${statusIcon}
                </div>
            </div>
        `;

        messagesList.appendChild(messageDiv);

        // Make username clickable if it's from another user
        if (!isOwnMessage && data.sender_name) {
            makeMessageUserNameClickable(messageDiv, data.sender_name);
        }

        totalMessages++;
        updateMessageCount();
        scrollToBottom();

        // Mark message as read if it's from another user and we're online
        if (!isOwnMessage && isConnected && data.message_id) {
            setTimeout(() => markMessageAsRead(data.message_id), 1000);
        }

        // Animation for new messages
        if (isNewMessage) {
            messageDiv.style.animation = 'messageFlash 1s ease-out';

            // Sound for messages from others
            if (!isOwnMessage) {
                playNotificationSound();
            }
        }
    }

    // Update message read status
    function updateMessageReadStatus(messageId) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
            const statusSpan = messageDiv.querySelector('span[title="Delivered"]');
            if (statusSpan) {
                statusSpan.innerHTML = '‚úì‚úì';
                statusSpan.title = 'Read';
            }
        }
    }

    // Play notification sound
    function playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
            console.log('üîá Could not play notification sound');
        }
    }

    // WebSocket event handlers
    chatSocket.onopen = function(e) {
        console.log('‚úÖ Enhanced WebSocket connected');
        updateConnectionStatus('Connected', 'bg-green-200', 'text-green-800');
        connectionInfo.textContent = 'Real-time chat with read receipts';
        isConnected = true;
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    };

    chatSocket.onclose = function(e) {
        console.log('‚ùå WebSocket disconnected:', e.code);
        updateConnectionStatus('Disconnected', 'bg-red-200', 'text-red-800');
        connectionInfo.textContent = 'Connection lost';
        isConnected = false;
        messageInput.disabled = true;
        sendButton.disabled = true;
        hideTypingIndicator();
    };

    chatSocket.onerror = function(e) {
        console.error('‚ö†Ô∏è WebSocket error:', e);
        updateConnectionStatus('Error', 'bg-red-200', 'text-red-800');
        connectionInfo.textContent = 'Connection error';
        isConnected = false;
        messageInput.disabled = true;
        sendButton.disabled = true;
    };

    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            console.log('üì® Received:', data.type, data);

            switch(data.type) {
                case 'connection_established':
                    console.log('‚úÖ Connection confirmed with enhanced features');
                    break;

                case 'existing_message':
                    addMessage(data, false);
                    break;

                case 'new_message':
                    addMessage(data, true);
                    console.log('üöÄ New message with delivery status');
                    break;

                case 'user_status':
                    updateOtherUserStatus(data.username, data.is_online, data.last_seen);
                    console.log(`üë§ ${data.username} is ${data.is_online ? 'online' : 'offline'}`);
                    break;

                case 'message_read':
                    updateMessageReadStatus(data.message_id);
                    console.log(`üëÄ Message read by ${data.read_by_username}`);
                    break;

                case 'typing_status':
                    if (data.is_typing) {
                        showTypingIndicator(data.username);
                    } else {
                        hideTypingIndicator();
                    }
                    break;

                case 'error':
                    console.error('‚ùå Server error:', data.message);
                    alert('Error: ' + data.message);
                    break;
            }

        } catch (error) {
            console.error('üí• Error parsing message:', error);
        }
    };

    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message || !isConnected) return;

        console.log('üì§ Sending enhanced message:', message);

        // Send via WebSocket
        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message
        }));

        // Clear input and stop typing
        messageInput.value = '';
        if (isTyping) {
            sendTypingStatus(false);
            isTyping = false;
        }
        messageInput.focus();
    });

    // Handle typing indicators
    messageInput.addEventListener('input', function() {
        if (!isTyping) {
            sendTypingStatus(true);
            isTyping = true;
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            if (isTyping) {
                sendTypingStatus(false);
                isTyping = false;
            }
        }, 1000);
    });

    // Auto-focus on input
    if (messageInput) {
        messageInput.focus();
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes messageFlash {
        0% { transform: scale(1); background-color: rgba(59, 130, 246, 0.1); }
        50% { transform: scale(1.02); background-color: rgba(59, 130, 246, 0.2); }
        100% { transform: scale(1); background-color: transparent; }
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .message-username:hover {
        text-decoration: underline !important;
        color: #2563eb !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
