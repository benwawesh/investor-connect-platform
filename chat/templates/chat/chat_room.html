{% extends 'base.html' %}

{% block title %}Enhanced Chat - InvestorConnect{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Chat Header with Online Status and Profile Links -->
    <div class="bg-white rounded-t-lg shadow p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{% url 'chat:chat_list' %}" class="text-blue-600 hover:text-blue-800">
                    ← Back to Messages
                </a>
                <div class="flex items-center space-x-3">
                    <!-- Profile Picture -->
                    {% if other_user and other_user.username %}
                        <a href="{% url 'accounts:profile_detail' username=other_user.username %}" class="flex-shrink-0">
                            {% if other_user.userprofileextension.profile_picture %}
                                <img src="{{ other_user.userprofileextension.profile_picture.url }}"
                                     alt="{{ other_user.username }}"
                                     class="w-10 h-10 rounded-full object-cover border-2 border-gray-200 hover:border-blue-400 transition-colors">
                            {% else %}
                                <div class="w-10 h-10 rounded-full
                                    {% if other_user.is_staff %}bg-red-500
                                    {% elif other_user.is_investor %}bg-green-500
                                    {% else %}bg-blue-500{% endif %}
                                    flex items-center justify-center border-2 border-gray-200 hover:border-blue-400 transition-colors">
                                    <span class="text-white font-medium">{{ other_user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                        </a>
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center border-2 border-gray-200">
                            <span class="text-white font-medium">?</span>
                        </div>
                    {% endif %}

                    <!-- Name and Status -->
                    <div>
                        <h2 class="text-xl font-semibold">
                            {% if other_user and other_user.username %}
                                <a href="{% url 'accounts:profile_detail' username=other_user.username %}"
                                   class="hover:text-blue-600 transition-colors flex items-center">
                                    {% if other_user.userprofileextension.get_full_name %}
                                        {{ other_user.userprofileextension.get_full_name }}
                                    {% else %}
                                        {{ other_user.username }}
                                    {% endif %}
                                    {% if other_user.is_staff %}
                                        <i class="fas fa-shield-alt text-red-600 ml-2 text-sm" title="Administrator"></i>
                                    {% elif other_user.is_investor %}
                                        <i class="fas fa-coins text-green-600 ml-2 text-sm" title="Investor"></i>
                                    {% else %}
                                        <i class="fas fa-lightbulb text-blue-600 ml-2 text-sm" title="Entrepreneur"></i>
                                    {% endif %}
                                </a>
                            {% else %}
                                <span class="text-gray-500">Unknown User</span>
                            {% endif %}
                        </h2>
                        <div id="otherUserStatus" class="text-sm text-gray-500">
                            Checking status...
                        </div>
                    </div>
                </div>
            </div>
            <div id="connectionStatus" class="text-sm px-3 py-1 rounded-full bg-yellow-200 text-yellow-800">
                Connecting...
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="bg-gray-50 border h-96 overflow-y-auto p-4" id="messagesContainer">
        <div id="messagesList">
            <div class="text-center py-8 text-gray-500" id="loadingText">
                Loading chat history...
            </div>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div class="bg-gray-100 px-4 py-2 border-b" id="typingContainer" style="display: none;">
        <div id="typingIndicator" class="text-sm text-blue-600 italic">
            <!-- Typing indicator will appear here -->
        </div>
    </div>

    <!-- File Preview (when file is selected) -->
    <div id="filePreviewContainer" class="bg-white border-t px-4 py-2" style="display: none;">
        <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-center space-x-3">
                <i class="text-blue-600 text-xl" id="fileIconPreview"></i>
                <div>
                    <p class="text-sm font-medium text-gray-900" id="fileNamePreview"></p>
                    <p class="text-xs text-gray-500" id="fileSizePreview"></p>
                </div>
            </div>
            <button type="button" id="removeFileBtn" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Message Input -->
    <div class="bg-white rounded-b-lg shadow p-4">
        <form id="messageForm" class="space-y-2" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="flex space-x-2">
                <!-- File Upload Button -->
                <label for="fileInput" class="flex items-center justify-center w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition-colors" title="Attach file (Images, PDF, Text only - Max 20MB)">
                    <i class="fas fa-paperclip text-gray-600"></i>
                    <input type="file" id="fileInput" class="hidden"
                           accept="image/*,.pdf,.txt" disabled>
                </label>

                <input type="text" id="messageInput" placeholder="Type your message..."
                       class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       disabled autocomplete="off">

                <button type="submit" id="sendButton"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center"
                        disabled>
                    <i class="fas fa-paper-plane mr-2"></i> Send
                </button>
            </div>
        </form>
        <div class="mt-2 flex justify-between items-center">
            <span id="messageCount" class="text-xs text-gray-500">Loading...</span>
            <span id="connectionInfo" class="text-xs text-gray-500">Connecting...</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messagesList = document.getElementById('messagesList');
    const messagesContainer = document.getElementById('messagesContainer');
    const connectionStatus = document.getElementById('connectionStatus');
    const otherUserStatus = document.getElementById('otherUserStatus');
    const sendButton = document.getElementById('sendButton');
    const messageCount = document.getElementById('messageCount');
    const loadingText = document.getElementById('loadingText');
    const typingContainer = document.getElementById('typingContainer');
    const typingIndicator = document.getElementById('typingIndicator');
    const connectionInfo = document.getElementById('connectionInfo');

    // File upload elements
    const fileInput = document.getElementById('fileInput');
    const filePreviewContainer = document.getElementById('filePreviewContainer');
    const fileNamePreview = document.getElementById('fileNamePreview');
    const fileSizePreview = document.getElementById('fileSizePreview');
    const fileIconPreview = document.getElementById('fileIconPreview');
    const removeFileBtn = document.getElementById('removeFileBtn');

    // State variables
    let totalMessages = 0;
    let isConnected = false;
    let hasLoadedHistory = false;
    let isTyping = false;
    let typingTimer = null;
    let otherUserIsOnline = false;
    let otherUserName = '';
    let selectedFile = null;

    // Rate limiting tracking
    let fileUploadCount = parseInt(localStorage.getItem('fileUploadCount') || '0');
    let lastUploadReset = parseInt(localStorage.getItem('lastUploadReset') || Date.now());

    // Reset counter daily
    if (Date.now() - lastUploadReset > 86400000) {
        fileUploadCount = 0;
        lastUploadReset = Date.now();
        localStorage.setItem('fileUploadCount', '0');
        localStorage.setItem('lastUploadReset', lastUploadReset.toString());
    }

    // Get other user's username
    const otherUsername = '{{ other_user.username|default:"" }}';
    const roomId = '{{ chat_room.id }}';
    const currentUserId = {{ user.id }};
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsPath = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;

    console.log('Connecting to WebSocket:', wsPath);
    let chatSocket = new WebSocket(wsPath);

    // File upload handlers
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check upload limit
            if (fileUploadCount >= 50) {
                alert('Daily upload limit reached (50 files). Please try again tomorrow.');
                fileInput.value = '';
                return;
            }

            // Check file size - 5MB limit
            if (file.size > 20 * 1024 * 1024) {
                alert('File size exceeds 20MB limit');
                fileInput.value = '';
                return;
            }

            // Validate extension
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.txt'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExt)) {
                alert('File type not allowed. Allowed: Images, PDF, Text files only');
                fileInput.value = '';
                return;
            }

            selectedFile = file;
            showFilePreview(file);
        }
    });

    removeFileBtn.addEventListener('click', function() {
        clearFileSelection();
    });

    function showFilePreview(file) {
        fileNamePreview.textContent = file.name;
        fileSizePreview.textContent = formatFileSize(file.size);
        const iconClass = getFileIcon(file.type);
        fileIconPreview.className = `fas fa-${iconClass} text-blue-600 text-xl`;
        filePreviewContainer.style.display = 'block';
    }

    function clearFileSelection() {
        selectedFile = null;
        fileInput.value = '';
        filePreviewContainer.style.display = 'none';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'file-image';
        if (mimeType.includes('pdf')) return 'file-pdf';
        if (mimeType.includes('text')) return 'file-alt';
        return 'file';
    }

    // Utility functions
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function formatLastSeen(isoString) {
        if (!isoString) return 'Unknown';
        const date = new Date(isoString);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes}m ago`;
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
    }

    function updateConnectionStatus(text, bgColor, textColor) {
        connectionStatus.textContent = text;
        connectionStatus.className = `text-sm px-3 py-1 rounded-full ${bgColor} ${textColor}`;
    }

    function updateOtherUserStatus(username, isOnline, lastSeen) {
        otherUserName = username;
        otherUserIsOnline = isOnline;
        if (isOnline) {
            otherUserStatus.innerHTML = `<span class="text-green-600">● Online</span>`;
        } else {
            otherUserStatus.innerHTML = `<span class="text-gray-500">○ Last seen ${formatLastSeen(lastSeen)}</span>`;
        }
    }

    function updateMessageCount() {
        messageCount.textContent = `${totalMessages} message${totalMessages !== 1 ? 's' : ''}`;
    }

    function hideLoadingText() {
        if (loadingText && !hasLoadedHistory) {
            loadingText.style.display = 'none';
            hasLoadedHistory = true;
        }
    }

    function showTypingIndicator(username) {
        typingIndicator.textContent = `${username} is typing...`;
        typingContainer.style.display = 'block';
        scrollToBottom();
    }

    function hideTypingIndicator() {
        typingContainer.style.display = 'none';
    }

    function sendTypingStatus(typing) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': typing ? 'typing_start' : 'typing_stop'
            }));
        }
    }

    function markMessageAsRead(messageId) {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'message_read',
                'message_id': messageId
            }));
        }
    }

    function makeMessageUserNameClickable(messageElement, username) {
        const userNameSpan = messageElement.querySelector('.message-username');
        if (userNameSpan && username !== '{{ user.username }}' && username) {
            userNameSpan.style.cursor = 'pointer';
            userNameSpan.style.color = '#2563eb';
            userNameSpan.addEventListener('click', function() {
                window.location.href = `{% url 'accounts:profile_detail' username='PLACEHOLDER' %}`.replace('PLACEHOLDER', username);
            });
            userNameSpan.addEventListener('mouseenter', function() {
                this.style.textDecoration = 'underline';
            });
            userNameSpan.addEventListener('mouseleave', function() {
                this.style.textDecoration = 'none';
            });
        }
    }

    // Add message with file support
    function addMessage(data, isNewMessage = false) {
        hideLoadingText();
        const isOwnMessage = data.is_own_message || (data.sender_id === currentUserId);
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${isOwnMessage ? 'text-right' : 'text-left'}`;
        messageDiv.setAttribute('data-message-id', data.message_id || 'temp');

        const bubbleClass = isOwnMessage ?
            'bg-blue-600 text-white' :
            'bg-white border border-gray-200 text-gray-900';
        const timeClass = isOwnMessage ? 'text-blue-100' : 'text-gray-500';

        let statusIcon = '';
        if (isOwnMessage) {
            if (data.read) {
                statusIcon = '<span class="text-xs ml-1" title="Read">✓✓</span>';
            } else if (data.delivered) {
                statusIcon = '<span class="text-xs ml-1" title="Delivered">✓</span>';
            } else {
                statusIcon = '<span class="text-xs ml-1" title="Sending">○</span>';
            }
        }

        const newIndicator = isNewMessage ?
            '<span class="text-xs opacity-75 animate-pulse mr-1">●</span>' : '';
        const usernameClass = !isOwnMessage ? 'message-username' : '';

        // Build file attachment HTML if present
        let fileHTML = '';
        if (data.file) {
            const isImage = data.file.type && data.file.type.startsWith('image/');
            if (isImage) {
                fileHTML = `
                    <div class="mt-2">
                        <a href="${data.file.url}" target="_blank" class="block">
                            <img src="${data.file.url}" alt="${data.file.name}"
                                 class="max-w-xs rounded-lg border ${isOwnMessage ? 'border-blue-400' : 'border-gray-300'}">
                        </a>
                        <p class="text-xs mt-1 ${timeClass}">${data.file.name}</p>
                    </div>
                `;
            } else {
                fileHTML = `
                    <a href="${data.file.url}" target="_blank" download
                       class="mt-2 flex items-center space-x-2 p-2 rounded ${isOwnMessage ? 'bg-blue-500' : 'bg-gray-100'} hover:opacity-80 transition-opacity">
                        <i class="fas fa-${data.file.icon || 'file'} text-lg"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${data.file.name}</p>
                            <p class="text-xs ${timeClass}">${data.file.size}</p>
                        </div>
                        <i class="fas fa-download text-sm"></i>
                    </a>
                `;
            }
        }

        messageDiv.innerHTML = `
            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                <div class="text-xs mb-1 opacity-75 ${usernameClass}">
                    ${newIndicator}${isOwnMessage ? 'You' : data.sender_name}
                </div>
                ${data.message ? `<p class="text-sm break-words">${data.message}</p>` : ''}
                ${fileHTML}
                <div class="flex justify-between items-center mt-1">
                    <span class="text-xs ${timeClass}">
                        ${formatTime(data.timestamp)}
                    </span>
                    ${statusIcon}
                </div>
            </div>
        `;

        messagesList.appendChild(messageDiv);
        if (!isOwnMessage && data.sender_name) {
            makeMessageUserNameClickable(messageDiv, data.sender_name);
        }
        totalMessages++;
        updateMessageCount();
        scrollToBottom();
        if (!isOwnMessage && isConnected && data.message_id) {
            setTimeout(() => markMessageAsRead(data.message_id), 1000);
        }
        if (isNewMessage) {
            messageDiv.style.animation = 'messageFlash 1s ease-out';
            if (!isOwnMessage) {
                playNotificationSound();
            }
        }
    }

    function updateMessageReadStatus(messageId) {
        const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageDiv) {
            const statusSpan = messageDiv.querySelector('span[title="Delivered"]');
            if (statusSpan) {
                statusSpan.innerHTML = '✓✓';
                statusSpan.title = 'Read';
            }
        }
    }

    function playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
            console.log('Could not play notification sound');
        }
    }

    // WebSocket event handlers
    chatSocket.onopen = function(e) {
        console.log('WebSocket connected');
        updateConnectionStatus('Connected', 'bg-green-200', 'text-green-800');
        connectionInfo.textContent = 'Secure file sharing (Images, PDF, Text - 20MB max)';
        isConnected = true;
        messageInput.disabled = false;
        fileInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    };

    chatSocket.onclose = function(e) {
        console.log('WebSocket disconnected');
        updateConnectionStatus('Disconnected', 'bg-red-200', 'text-red-800');
        connectionInfo.textContent = 'Connection lost';
        isConnected = false;
        messageInput.disabled = true;
        fileInput.disabled = true;
        sendButton.disabled = true;
        hideTypingIndicator();
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error');
        updateConnectionStatus('Error', 'bg-red-200', 'text-red-800');
        connectionInfo.textContent = 'Connection error';
        isConnected = false;
        messageInput.disabled = true;
        fileInput.disabled = true;
        sendButton.disabled = true;
    };

    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            switch(data.type) {
                case 'connection_established':
                    console.log('Connection confirmed');
                    break;
                case 'existing_message':
                    addMessage(data, false);
                    break;
                case 'new_message':
                    addMessage(data, true);
                    break;
                case 'user_status':
                    updateOtherUserStatus(data.username, data.is_online, data.last_seen);
                    break;
                case 'message_read':
                    updateMessageReadStatus(data.message_id);
                    break;
                case 'typing_status':
                    if (data.is_typing) {
                        showTypingIndicator(data.username);
                    } else {
                        hideTypingIndicator();
                    }
                    break;
                case 'error':
                    console.error('Server error:', data.message);
                    alert('Error: ' + data.message);
                    break;
            }
        } catch (error) {
            console.error('Error parsing message:', error);
        }
    };

    // Handle form submission with file upload
    messageForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();

        if (!message && !selectedFile) return;
        if (!isConnected && !selectedFile) return;

        // If we have a file, use AJAX to upload
        if (selectedFile) {
            const formData = new FormData();
            formData.append('file', selectedFile);
            if (message) {
                formData.append('message', message);
            }

            try {
                const response = await fetch(`/chat/${roomId}/send/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const result = await response.json();
                if (result.success) {
                    console.log('File uploaded successfully');
                    // Update rate limit counter
                    fileUploadCount++;
                    localStorage.setItem('fileUploadCount', fileUploadCount.toString());
                    clearFileSelection();
                    messageInput.value = '';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload file');
            }
        } else if (message) {
            // No file, use WebSocket
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            messageInput.value = '';
        }

        if (isTyping) {
            sendTypingStatus(false);
            isTyping = false;
        }
        messageInput.focus();
    });

    // Handle typing indicators
    messageInput.addEventListener('input', function() {
        if (!isTyping) {
            sendTypingStatus(true);
            isTyping = true;
        }
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            if (isTyping) {
                sendTypingStatus(false);
                isTyping = false;
            }
        }, 1000);
    });

    if (messageInput) {
        messageInput.focus();
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes messageFlash {
        0% { transform: scale(1); background-color: rgba(59, 130, 246, 0.1); }
        50% { transform: scale(1.02); background-color: rgba(59, 130, 246, 0.2); }
        100% { transform: scale(1); background-color: transparent; }
    }
    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .message-username:hover {
        text-decoration: underline !important;
        color: #2563eb !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}