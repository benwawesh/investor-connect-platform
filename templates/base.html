<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BazuuConnect{% endblock %}</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    :root {
        --color-primary: #1e40af;
        --color-secondary: #3b82f6;
        --color-accent: #10b981;
        --color-accent-dark: #059669;
        --color-bg-light: #eff6ff;
        --color-bg-green: #ecfdf5;
        --color-text: #1f2937;
        --color-text-subtle: #6b7280;
    }

    body {
        padding-top: 80px; /* Account for fixed navbar height */
    }

    .post-image {
        max-height: 500px;
        width: 100%;
        object-fit: contain;
        background-color: #f3f4f6;
    }

    .post-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f3f4f6;
        min-height: 200px;
    }

    /* Notification badge styles */
    .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        animation: pulse 2s infinite;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        50% {
            opacity: 0.9;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
        }
    }

    /* Sticky Navigation Bar with Blue/Green Theme */
    nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        box-shadow: 0 4px 20px rgba(30, 64, 175, 0.2);
        border-bottom: 3px solid var(--color-accent);
        transition: all 0.3s ease;
    }

    nav.scrolled {
        box-shadow: 0 6px 30px rgba(30, 64, 175, 0.3);
    }

    /* Profile dropdown styles */
    .profile-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        background: white;
        border: 2px solid var(--color-accent);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        min-width: 240px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }

    .profile-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    /* Nav links styling - White text on blue background */
    .nav-link {
        color: white !important;
        transition: all 0.3s ease;
        position: relative;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }

    .nav-link:hover {
        color: var(--color-accent) !important;
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-link::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 2px;
        background: var(--color-accent);
        transition: width 0.3s ease;
    }

    .nav-link:hover::after {
        width: 80%;
    }

    /* Logo styling */
    .logo-link {
        color: white !important;
        font-weight: 900;
        font-size: 1.5rem;
        transition: all 0.3s ease;
    }

    .logo-link:hover {
        color: var(--color-accent) !important;
        transform: translateY(-2px);
    }

    .logo-icon {
        color: var(--color-accent);
        font-size: 1.75rem;
    }

    /* User badge styling */
    .user-badge {
        background: var(--color-accent);
        color: white;
        border: 2px solid white;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 700;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .user-badge:hover {
        background: var(--color-accent-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
    }

    /* Button styling for Login (primary green) */
    .btn-login {
        background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark));
        color: white;
        transition: all 0.3s ease;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    /* Button styling for Signup (white outline) */
    .btn-signup {
        background: transparent;
        color: white;
        border: 2px solid white;
        transition: all 0.3s ease;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
    }

    .btn-signup:hover {
        background: white;
        color: var(--color-primary);
        transform: translateY(-2px);
    }

    /* Profile button */
    .profile-button {
        color: white !important;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .profile-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-accent) !important;
    }

    /* Mobile menu styling */
    #mobile-menu {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        border-top: 3px solid var(--color-accent);
    }

    #mobile-menu .nav-link {
        color: white !important;
    }

    #mobile-menu .nav-link:hover {
        background: rgba(255, 255, 255, 0.15);
        color: var(--color-accent) !important;
    }

    /* Mobile menu button */
    .mobile-menu-btn {
        color: white;
        font-size: 1.5rem;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .mobile-menu-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-accent);
    }

    /* Alert bar styling */
    .alert-bar {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        border-left: 4px solid #ef4444;
        margin-top: 80px; /* Account for fixed navbar */
    }

    @media (max-width: 768px) {
        .post-image {
            max-height: 300px;
        }

        body {
            padding-top: 70px;
        }
    }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 font-sans">
    <!-- Fixed Navigation -->
    <nav id="mainNav">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <div class="flex items-center">
                {% if user.is_authenticated %}
                <a href="{% url 'accounts:dashboard' %}" class="logo-link">
                    <i class="fas fa-rocket logo-icon mr-2"></i>BazuuConnect
                </a>
                {% else %}
                <a href="/" class="logo-link">
                    <i class="fas fa-rocket logo-icon mr-2"></i>BazuuConnect
                </a>
                {% endif %}
            </div>

            <!-- Navigation Links -->
           {% if user.is_authenticated %}
            <div class="hidden md:flex items-center space-x-2">
                <a href="{% url 'accounts:dashboard' %}" class="nav-link">
                    <i class="fas fa-tachometer-alt mr-1"></i>Dashboard
                </a>

                <!-- Pitch-related links for entrepreneurs and multi-role users -->
                {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                <a href="{% url 'pitches:pitch_list' %}" class="nav-link">
                    <i class="fas fa-lightbulb mr-1"></i>My Pitches
                </a>
                {% endif %}

                <!-- Job-related links for job seekers and multi-role users -->
                {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                <a href="{% url 'jobs:job_list' %}" class="nav-link">
                    <i class="fas fa-briefcase mr-1"></i>Browse Jobs
                </a>
                {% endif %}

                <!-- Investor-specific links -->
                {% if user.user_type == 'investor' %}
                <a href="{% url 'pitches:investor_pitch_list' %}" class="nav-link">
                    <i class="fas fa-search mr-1"></i>Browse Pitches
                </a>
                {% endif %}

                <!-- Common links for all users -->
                <a href="{% url 'pitches:investor_posts_feed' %}" class="nav-link">
                    <i class="fas fa-newspaper mr-1"></i>Insights
                </a>

                <!-- Enhanced Messages Link with Notification Badge -->
                <a href="{% url 'chat:chat_list' %}" class="nav-link relative" id="messagesLink">
                    <i class="fas fa-comments mr-1"></i>Messages
                    <span class="notification-badge" id="navigationBadge" style="display: none;">0</span>
                </a>

                {% if user.is_staff %}
                <a href="{% url 'admin_panel:admin_dashboard' %}" class="nav-link">
                    <i class="fas fa-cog mr-1"></i>Admin
                </a>
                {% endif %}
            </div>

            <!-- User Info with Profile Dropdown -->
            <div class="flex items-center space-x-3">
                <!-- Enhanced User Type Badge -->
                {% if user.user_type == 'investor' %}
                    <span class="user-badge">
                        <i class="fas fa-coins mr-1"></i>Investor
                    </span>
                {% elif user.is_staff or user.is_superuser %}
                    <span class="user-badge" style="background: #9333ea;">
                        <i class="fas fa-shield-alt mr-1"></i>Admin
                    </span>
                {% elif user.user_type == 'job_seeker' %}
                    <span class="user-badge">
                        <i class="fas fa-user-tie mr-1"></i>Job Seeker
                    </span>
                {% else %}
                    <span class="user-badge">
                        <i class="fas fa-rocket mr-1"></i>Entrepreneur
                    </span>
                {% endif %}

                <!-- Profile Dropdown -->
                <div class="relative">
                    <button onclick="toggleProfileDropdown()" class="profile-button flex items-center space-x-2">
                        <span>{{ user.username }}</span>
                        <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse" id="userUnreadIndicator" style="display: none;">0 unread</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="py-2">
                            <div class="px-4 py-3 border-b-2 border-gray-200">
                                <p class="text-sm font-bold text-gray-900">{{ user.username }}</p>
                                <p class="text-sm text-gray-600">{{ user.email }}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    {% if user.user_type == 'investor' %}
                                        Investor Account
                                    {% elif user.user_type == 'job_seeker' %}
                                        Job Seeker Account
                                    {% elif user.is_staff %}
                                        Administrator Account
                                    {% else %}
                                        Entrepreneur Account
                                    {% endif %}
                                </p>
                            </div>

                            <a href="{% url 'accounts:profile_view' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i class="fas fa-user mr-3 text-green-600"></i>
                                View Profile
                            </a>

                            <a href="{% url 'accounts:profile_edit' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i class="fas fa-edit mr-3 text-green-600"></i>
                                Edit Profile
                            </a>

                            <a href="{% url 'accounts:profile_settings_menu' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i class="fas fa-cog mr-3 text-green-600"></i>
                                Settings
                            </a>

                            <!-- Role-specific quick links -->
                            {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                            <div class="border-t-2 border-gray-200"></div>
                            <div class="px-4 py-2">
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Quick Access</p>
                            </div>

                            {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                            <a href="{% url 'pitches:create_pitch' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i class="fas fa-plus mr-3 text-green-600"></i>
                                Submit New Pitch
                            </a>
                            {% endif %}

                            {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                            <a href="{% url 'jobs:job_list' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition-colors">
                                <i class="fas fa-search mr-3 text-green-600"></i>
                                Find Jobs
                            </a>
                            {% endif %}
                            {% endif %}

                            <div class="border-t-2 border-gray-200"></div>

                            <a href="{% url 'accounts:logout' %}" class="flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors font-semibold">
                                <i class="fas fa-sign-out-alt mr-3 text-red-500"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Guest Navigation -->
            <div class="flex items-center space-x-4">
                <a href="{% url 'accounts:login' %}" class="btn-login">
                    Login
                </a>
                <a href="{% url 'accounts:signup_with_payment' %}" class="btn-signup">
                    Sign Up
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Mobile Navigation Menu -->
        {% if user.is_authenticated %}
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="{% url 'accounts:dashboard' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>

                {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                <a href="{% url 'pitches:pitch_list' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-lightbulb mr-2"></i>My Pitches
                </a>
                {% endif %}

                {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                <a href="{% url 'jobs:job_list' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-briefcase mr-2"></i>Browse Jobs
                </a>
                {% endif %}

                {% if user.user_type == 'investor' %}
                <a href="{% url 'pitches:investor_pitch_list' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-search mr-2"></i>Browse Pitches
                </a>
                {% endif %}

                <a href="{% url 'pitches:investor_posts_feed' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-newspaper mr-2"></i>Insights
                </a>

                <a href="{% url 'chat:chat_list' %}" class="block px-3 py-2 rounded nav-link relative">
                    <i class="fas fa-comments mr-2"></i>Messages
                    <span class="inline-block bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2" id="mobileBadge" style="display: none;">0</span>
                </a>

                <div class="border-t-2 border-white border-opacity-20 pt-2 mt-2">
                    <a href="{% url 'accounts:profile_view' %}" class="block px-3 py-2 rounded nav-link">
                        <i class="fas fa-user mr-2"></i>View Profile
                    </a>

                    <a href="{% url 'accounts:profile_edit' %}" class="block px-3 py-2 rounded nav-link">
                        <i class="fas fa-edit mr-2"></i>Edit Profile
                    </a>

                    <a href="{% url 'accounts:profile_settings_menu' %}" class="block px-3 py-2 rounded nav-link">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>

                {% if user.is_staff %}
                <a href="{% url 'admin_panel:admin_dashboard' %}" class="block px-3 py-2 rounded nav-link">
                    <i class="fas fa-shield-alt mr-2"></i>Admin Panel
                </a>
                {% endif %}

                <div class="border-t-2 border-white border-opacity-20 pt-2 mt-2">
                    <a href="{% url 'accounts:logout' %}" class="block px-3 py-2 text-red-300 hover:bg-red-900 hover:bg-opacity-30 rounded font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mobile menu button -->
        {% if user.is_authenticated %}
        <div class="md:hidden absolute top-4 right-4">
            <button onclick="toggleMobileMenu()" class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        {% endif %}
    </div>
    </nav>

    <!-- Alert Bar -->
    {% if user.is_authenticated %}
    <div class="alert-bar border-l-4 border-red-500 p-4" id="alertBar" style="display: none;">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-envelope text-red-600 mr-3"></i>
                <p class="text-sm text-red-800 font-semibold">
                    <span id="alertText">You have unread messages.</span>
                    <a href="{% url 'chat:chat_list' %}" class="underline hover:text-red-600 ml-2">
                        View messages
                    </a>
                </p>
            </div>
            <button onclick="document.getElementById('alertBar').style.display='none'" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 mt-4">
        {% for message in messages %}
        <div class="bg-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-100 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-400 text-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-700 px-4 py-3 rounded mb-4">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-2 py-10">
        {% block content %}{% endblock %}
    </main>

    <script>
    // Add scroll effect to navbar
    window.addEventListener('scroll', function() {
        const nav = document.getElementById('mainNav');
        if (window.scrollY > 50) {
            nav.classList.add('scrolled');
        } else {
            nav.classList.remove('scrolled');
        }
    });

    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('profileDropdown');
        const button = event.target.closest('button');

        if (!button || !button.onclick || button.onclick.toString().indexOf('toggleProfileDropdown') === -1) {
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
    });

    {% if user.is_authenticated %}
    // WebSocket connection and management
    let notificationSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectNotificationSocket() {
        if (notificationSocket && notificationSocket.readyState === WebSocket.OPEN) {
            return;
        }

        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            notificationSocket = new WebSocket(`${protocol}//${window.location.host}/ws/notifications/`);

            notificationSocket.onopen = function(e) {
                console.log('Notification WebSocket connected');
                reconnectAttempts = 0;
            };

            notificationSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Notification received:', data);

                if (data.type === 'unread_count_update') {
                    requestAnimationFrame(() => {
                        updateNotificationBadges(data.unread_count);
                    });
                }
            };

            notificationSocket.onclose = function(e) {
                console.log('Notification WebSocket closed');
                notificationSocket = null;

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const reconnectDelay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);

                    console.log(`Attempting to reconnect WebSocket (attempt ${reconnectAttempts}/${maxReconnectAttempts}) in ${reconnectDelay}ms`);

                    setTimeout(function() {
                        connectNotificationSocket();
                    }, reconnectDelay);
                } else {
                    console.log('Max reconnection attempts reached.');
                }
            };

            notificationSocket.onerror = function(e) {
                console.error('Notification WebSocket error:', e);
            };

        } catch (error) {
            console.error('Failed to create WebSocket connection:', error);
        }
    }

    function updateNotificationBadges(count) {
        console.log('Updating badges to count:', count);

        const isInChatRoom = window.location.pathname.includes('/chat/') &&
                            window.location.pathname !== '/chat/' &&
                            !window.location.pathname.endsWith('/chat/');

        const navigationBadge = document.getElementById('navigationBadge');
        const userUnreadIndicator = document.getElementById('userUnreadIndicator');
        const mobileBadge = document.getElementById('mobileBadge');
        const alertBar = document.getElementById('alertBar');
        const alertText = document.getElementById('alertText');

        if (count > 0 && !isInChatRoom) {
            const displayCount = count > 9 ? '9+' : count.toString();

            if (navigationBadge) {
                navigationBadge.textContent = displayCount;
                navigationBadge.style.display = 'flex';
            }

            if (userUnreadIndicator) {
                userUnreadIndicator.textContent = `${count} unread`;
                userUnreadIndicator.style.display = 'inline-block';
            }

            if (mobileBadge) {
                mobileBadge.textContent = displayCount;
                mobileBadge.style.display = 'inline-block';
            }

            if (alertBar && alertText) {
                alertText.textContent = `You have ${count} unread message${count !== 1 ? 's' : ''}.`;
                alertBar.style.display = 'block';
            }

            document.title = `(${count}) BazuuConnect`;

        } else {
            if (navigationBadge) navigationBadge.style.display = 'none';
            if (userUnreadIndicator) userUnreadIndicator.style.display = 'none';
            if (mobileBadge) mobileBadge.style.display = 'none';
            if (alertBar) alertBar.style.display = 'none';
            document.title = document.title.replace(/^\(\d+\) /, '');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const initialCount = {{ unread_message_count|default:0 }};
        if (initialCount > 0) {
            updateNotificationBadges(initialCount);
        }

        connectNotificationSocket();
    });

    window.addEventListener('beforeunload', function() {
        if (notificationSocket) {
            notificationSocket.close();
        }
    });

    {% endif %}
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>