<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Investor Platform{% endblock %}</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS for Facebook-style images and notifications -->
    <style>
    .post-image {
        max-height: 500px;
        width: 100%;
        object-fit: contain;
        background-color: #f3f4f6;
    }

    .post-image-container {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f3f4f6;
        min-height: 200px;
    }

    /* Notification badge styles */
    .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ef4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        animation: pulse 2s infinite;
        z-index: 10;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
    }

    /* Profile dropdown styles */
    .profile-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease-in-out;
    }

    .profile-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .post-image {
            max-height: 300px;
        }
    }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 font-sans">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <div class="flex items-center">
                <a href="{% url 'accounts:dashboard' %}" class="text-2xl font-bold text-blue-600">
                    <i class="fas fa-handshake mr-2"></i>InvestorConnect
                </a>
            </div>

            <!-- Navigation Links -->
           {% if user.is_authenticated %}
            <div class="hidden md:flex items-center space-x-6">
                <a href="{% url 'accounts:dashboard' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-tachometer-alt mr-1"></i>Dashboard
                </a>

                <!-- Pitch-related links for entrepreneurs and multi-role users -->
                {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                <a href="{% url 'pitches:pitch_list' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-lightbulb mr-1"></i>My Pitches
                </a>
                {% endif %}

                <!-- Job-related links for job seekers and multi-role users -->
                {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                <a href="{% url 'jobs:job_list' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-briefcase mr-1"></i>Browse Jobs
                </a>
                {% endif %}

                <!-- Investor-specific links -->
                {% if user.user_type == 'investor' %}
                <a href="{% url 'pitches:investor_pitch_list' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-search mr-1"></i>Browse Pitches
                </a>
                {% endif %}

                <!-- Common links for all users -->
                <a href="{% url 'pitches:investor_posts_feed' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-newspaper mr-1"></i>Insights
                </a>

                <!-- Enhanced Messages Link with Notification Badge -->
                <a href="{% url 'chat:chat_list' %}" class="text-gray-700 hover:text-blue-600 transition-colors relative" id="messagesLink">
                    <i class="fas fa-comments mr-1"></i>Messages

                    <!-- Notification Badge -->
                    <span class="notification-badge" id="navigationBadge" style="display: none;">
                        0
                    </span>
                </a>

                {% if user.is_staff %}
                <a href="{% url 'admin_panel:admin_dashboard' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    <i class="fas fa-cog mr-1"></i>Admin Panel
                </a>
                {% endif %}
            </div>

            <!-- User Info with Profile Dropdown -->
            <div class="flex items-center space-x-4">
                <!-- Enhanced User Type Badge -->
                {% if user.user_type == 'investor' %}
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
                        <i class="fas fa-coins mr-1"></i>Investor
                    </span>
                {% elif user.is_staff or user.is_superuser %}
                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-sm">
                        <i class="fas fa-shield-alt mr-1"></i>Admin
                    </span>
                {% elif user.user_type == 'job_seeker' %}
                    <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-sm">
                        <i class="fas fa-user-tie mr-1"></i>Job Seeker
                    </span>
                {% else %}
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">
                        <i class="fas fa-rocket mr-1"></i>Entrepreneur
                    </span>
                {% endif %}

                <!-- Profile Dropdown -->
                <div class="relative">
                    <button onclick="toggleProfileDropdown()" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition-colors">
                        <span>{{ user.username }}</span>

                        <!-- Unread messages indicator -->
                        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full animate-pulse" id="userUnreadIndicator" style="display: none;">
                            0 unread
                        </span>

                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="py-2">
                            <div class="px-4 py-2 border-b border-gray-200">
                                <p class="text-sm font-medium text-gray-900">{{ user.username }}</p>
                                <p class="text-sm text-gray-500">{{ user.email }}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    {% if user.user_type == 'investor' %}
                                        Investor Account
                                    {% elif user.user_type == 'job_seeker' %}
                                        Job Seeker Account
                                    {% elif user.is_staff %}
                                        Administrator Account
                                    {% else %}
                                        Entrepreneur Account
                                    {% endif %}
                                </p>
                            </div>

                            <a href="{% url 'accounts:profile_view' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user mr-3 text-gray-400"></i>
                                View Profile
                            </a>

                            <a href="{% url 'accounts:profile_edit' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-edit mr-3 text-gray-400"></i>
                                Edit Profile
                            </a>

                            <a href="{% url 'accounts:profile_settings_menu' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-3 text-gray-400"></i>
                                Settings
                            </a>

                            <!-- Role-specific quick links -->
                            {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                            <div class="border-t border-gray-200"></div>
                            <div class="px-4 py-2">
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Quick Access</p>
                            </div>

                            {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                            <a href="{% url 'pitches:create_pitch' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-plus mr-3 text-gray-400"></i>
                                Submit New Pitch
                            </a>
                            {% endif %}

                            {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                            <a href="{% url 'jobs:job_list' %}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-search mr-3 text-gray-400"></i>
                                Find Jobs
                            </a>
                            {% endif %}
                            {% endif %}

                            <div class="border-t border-gray-200"></div>

                            <a href="{% url 'accounts:logout' %}" class="flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-50">
                                <i class="fas fa-sign-out-alt mr-3 text-red-400"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Guest Navigation -->
            <div class="flex items-center space-x-4">
                <a href="{% url 'accounts:login' %}" class="text-gray-700 hover:text-blue-600 transition-colors">
                    Login
                </a>
                <a href="{% url 'accounts:signup_with_payment' %}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                    Sign Up
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Mobile Navigation Menu (when screen is small) -->
        {% if user.is_authenticated %}
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div class="px-2 pt-2 pb-3 space-y-1 border-t border-gray-200">
                <a href="{% url 'accounts:dashboard' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>

                <!-- Mobile Pitch links for entrepreneurs and multi-role users -->
                {% if user.user_type == 'regular' or user.user_type == 'job_seeker' %}
                <a href="{% url 'pitches:pitch_list' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-lightbulb mr-2"></i>My Pitches
                </a>
                {% endif %}

                <!-- Mobile Job links for job seekers and multi-role users -->
                {% if user.user_type == 'job_seeker' or user.user_type == 'regular' %}
                <a href="{% url 'jobs:job_list' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-briefcase mr-2"></i>Browse Jobs
                </a>
                {% endif %}

                <!-- Mobile Investor links -->
                {% if user.user_type == 'investor' %}
                <a href="{% url 'pitches:investor_pitch_list' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-search mr-2"></i>Browse Pitches
                </a>
                {% endif %}

                <a href="{% url 'pitches:investor_posts_feed' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-newspaper mr-2"></i>Insights
                </a>

                <!-- Mobile Messages with Badge -->
                <a href="{% url 'chat:chat_list' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600 relative">
                    <i class="fas fa-comments mr-2"></i>Messages
                    <span class="inline-block bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-2" id="mobileBadge" style="display: none;">
                        0
                    </span>
                </a>

                <!-- Mobile Profile Section -->
                <div class="border-t border-gray-200 pt-2 mt-2">
                    <a href="{% url 'accounts:profile_view' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                        <i class="fas fa-user mr-2"></i>View Profile
                    </a>

                    <a href="{% url 'accounts:profile_edit' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                        <i class="fas fa-edit mr-2"></i>Edit Profile
                    </a>

                    <a href="{% url 'accounts:profile_settings_menu' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>

                {% if user.is_staff %}
                <a href="{% url 'admin_panel:admin_dashboard' %}" class="block px-3 py-2 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-shield-alt mr-2"></i>Admin Panel
                </a>
                {% endif %}

                <div class="border-t border-gray-200 pt-2 mt-2">
                    <a href="{% url 'accounts:logout' %}" class="block px-3 py-2 text-red-700 hover:text-red-800">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mobile menu button -->
        {% if user.is_authenticated %}
        <div class="md:hidden absolute top-4 right-4">
            <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-blue-600 focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
        {% endif %}
    </div>
    </nav>

    <!-- New Message Alert (appears on all pages when there are unread messages) -->
    {% if user.is_authenticated %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4" id="alertBar" style="display: none;">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-envelope text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">
                        <strong id="alertText">You have unread messages.</strong>
                        <a href="{% url 'chat:chat_list' %}" class="font-medium underline text-red-800 hover:text-red-900">
                            View messages
                        </a>
                    </p>
                </div>
            </div>
            <div class="flex-shrink-0">
                <button onclick="document.getElementById('alertBar').style.display='none'"
                        class="text-red-400 hover:text-red-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="max-w-7xl mx-auto px-4 mt-4">
        {% for message in messages %}
        <div class="bg-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-100 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-400 text-{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% elif message.tags == 'warning' %}yellow{% else %}blue{% endif %}-700 px-4 py-3 rounded mb-4">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>

    <script>
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('profileDropdown');
        const button = event.target.closest('button');

        if (!button || !button.onclick || button.onclick.toString().indexOf('toggleProfileDropdown') === -1) {
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
    });

    {% if user.is_authenticated %}
    // WebSocket connection and management
    let notificationSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectNotificationSocket() {
        if (notificationSocket && notificationSocket.readyState === WebSocket.OPEN) {
            return; // Already connected
        }

        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            notificationSocket = new WebSocket(`${protocol}//${window.location.host}/ws/notifications/`);

            notificationSocket.onopen = function(e) {
                console.log('Notification WebSocket connected');
                reconnectAttempts = 0; // Reset on successful connection
            };

            notificationSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Notification received:', data);

                if (data.type === 'unread_count_update') {
                    requestAnimationFrame(() => {
                        updateNotificationBadges(data.unread_count);
                    });
                }
            };

            notificationSocket.onclose = function(e) {
                console.log('Notification WebSocket closed');
                notificationSocket = null;

                // Only attempt to reconnect if we haven't exceeded the limit
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const reconnectDelay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000); // Exponential backoff, max 30s

                    console.log(`Attempting to reconnect WebSocket (attempt ${reconnectAttempts}/${maxReconnectAttempts}) in ${reconnectDelay}ms`);

                    setTimeout(function() {
                        connectNotificationSocket();
                    }, reconnectDelay);
                } else {
                    console.log('Max reconnection attempts reached. WebSocket will not reconnect automatically.');
                }
            };

            notificationSocket.onerror = function(e) {
                console.error('Notification WebSocket error:', e);
            };

        } catch (error) {
            console.error('Failed to create WebSocket connection:', error);
        }
    }

    function updateNotificationBadges(count) {
        console.log('Updating badges to count:', count);

        // Check if user is currently in a chat room
        const isInChatRoom = window.location.pathname.includes('/chat/') &&
                            window.location.pathname !== '/chat/' && // Not just the chat list
                            !window.location.pathname.endsWith('/chat/'); // Not just /chat/

        // If in a chat room, don't show notifications for that specific room
        if (isInChatRoom) {
            const pathParts = window.location.pathname.split('/');
            const currentRoomId = pathParts[pathParts.length - 2];
            console.log('User is in chat room:', currentRoomId, '- adjusting notifications');
        }

        // Get all badge elements
        const navigationBadge = document.getElementById('navigationBadge');
        const userUnreadIndicator = document.getElementById('userUnreadIndicator');
        const mobileBadge = document.getElementById('mobileBadge');
        const alertBar = document.getElementById('alertBar');
        const alertText = document.getElementById('alertText');

        if (count > 0 && !isInChatRoom) {
            const displayCount = count > 9 ? '9+' : count.toString();

            // Show all notification elements
            if (navigationBadge) {
                navigationBadge.textContent = displayCount;
                navigationBadge.style.display = 'flex';
            }

            if (userUnreadIndicator) {
                userUnreadIndicator.textContent = `${count} unread`;
                userUnreadIndicator.style.display = 'inline-block';
            }

            if (mobileBadge) {
                mobileBadge.textContent = displayCount;
                mobileBadge.style.display = 'inline-block';
            }

            if (alertBar && alertText) {
                alertText.textContent = `You have ${count} unread message${count !== 1 ? 's' : ''}.`;
                alertBar.style.display = 'block';
            }

            document.title = `(${count}) InvestorConnect`;

        } else {
            // Hide all notification elements
            if (navigationBadge) {
                navigationBadge.style.display = 'none';
            }

            if (userUnreadIndicator) {
                userUnreadIndicator.style.display = 'none';
            }

            if (mobileBadge) {
                mobileBadge.style.display = 'none';
            }

            if (alertBar) {
                alertBar.style.display = 'none';
            }

            document.title = document.title.replace(/^\(\d+\) /, '');
        }
    }

    // Initialize WebSocket connection on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial state based on server-side data
        const initialCount = {{ unread_message_count|default:0 }};
        if (initialCount > 0) {
            updateNotificationBadges(initialCount);
        }

        // Connect WebSocket
        connectNotificationSocket();
    });

    // Clean up WebSocket on page unload
    window.addEventListener('beforeunload', function() {
        if (notificationSocket) {
            notificationSocket.close();
        }
    });

    {% endif %}
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
